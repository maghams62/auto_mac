# Implementation Roadmap: Universal File Operations

## Quick Summary

**Goal:** Handle ANY file/folder query with just 3 universal tools + 1 reasoning pattern

**The Pattern:** DISCOVER → ANALYZE → TRANSFORM → ACT

**Key Insight:** Teach the LLM the pattern, not specific examples

---

## The 3 Universal Tools

### 1. `discover` - Find Things
```python
discover(scope="all_files")  # Get all files
discover(scope="folder", location="/Documents")  # Get folder contents
discover(scope="search", query="financial reports")  # Semantic search
```

### 2. `analyze` - Understand Things (LLM-powered)
```python
analyze(items, "similarity", "find duplicates")  # Find duplicates
analyze(items, "categorize", "by topic")  # Categorize
analyze(items, "match", "PDFs about AI")  # Match criteria
```

### 3. `transform` - Organize Things (LLM-powered)
```python
transform(items, "filter", "only PDFs")  # Filter
transform(items, "group", "by file type")  # Group
transform(items, "sort", "by date")  # Sort
```

Plus existing action tools: `organize_files`, `compose_email`, `create_zip_archive`, etc.

---

## How It Works: Your Query

**Query:** "Send all duplicated docs in my folder to my email"

**LLM Reasoning Process:**
```
Step 1: Parse Intent
├─ What things? "duplicated docs"
├─ From where? "my folder" (all folders)
└─ Do what? "send to my email"

Step 2: Map to 4-Stage Pattern
├─ DISCOVER: Need all docs
├─ ANALYZE: Need to identify "duplicated"
├─ TRANSFORM: Not needed
└─ ACT: Send via email

Step 3: Select Tools
├─ Stage 1: discover(scope="all_files")
├─ Stage 2: analyze(items, "similarity", "find duplicates")
└─ Stage 3: compose_email(attachments, send=true)

Step 4: Execute Pipeline
All Files → Find Duplicates → Email Them
```

**Result:** ✅ Works without hardcoded duplicate detection logic!

---

## More Examples (Auto-Generated by Pattern)

### Example 1: "Find PDFs about AI"
```
Pattern: DISCOVER → TRANSFORM
Tools:
  1. discover(scope="all_files")
  2. transform(items, "filter", "only PDF files about AI")
```

### Example 2: "Organize images by date into folders"
```
Pattern: DISCOVER → TRANSFORM → TRANSFORM → ACT
Tools:
  1. discover(scope="all_files")
  2. transform(items, "filter", "only image files")
  3. transform(items, "group", "by creation date")
  4. For each group: organize_files(folder_name, files)
```

### Example 3: "Find files similar to report.pdf"
```
Pattern: DISCOVER → ANALYZE
Tools:
  1. discover(scope="all_files")
  2. analyze(items, "similarity", "similar to report.pdf")
```

### Example 4: "Group my documents by topic and create folders"
```
Pattern: DISCOVER → ANALYZE → ACT (loop)
Tools:
  1. discover(scope="all_files")
  2. analyze(items, "categorize", "by topic")
  3. For each category: organize_files(category_name, files)
```

**Notice:** No specific examples needed in prompts! LLM applies the pattern.

---

## Prompt Architecture

### ❌ Old Way (Many Examples)
```
prompts/few_shot_examples.md:
- Example 1: Find duplicates and email
- Example 2: Find PDFs about topic
- Example 3: Organize by date
- Example 4: Group by category
- Example 5: Find similar files
- Example 6: ...
- Example 50: ...
```

**Problem:** Overwhelming, can't cover all cases, LLM memorizes instead of reasons

### ✅ New Way (Pattern + 3 Meta-Examples)
```
prompts/task_decomposition.md:
- Universal File Operation Framework
- 4-Stage Pattern: DISCOVER → ANALYZE → TRANSFORM → ACT
- Decision Tree: When to use each stage
- Embedding-Aware Strategy

prompts/few_shot_examples.md:
- Meta-Example 1: Simple pattern (DISCOVER → ACT)
- Meta-Example 2: Medium pattern (DISCOVER → ANALYZE → ACT)
- Meta-Example 3: Complex pattern (DISCOVER → ANALYZE → loop ACT)
```

**Benefit:** Minimal, teaches reasoning, LLM generalizes to infinite queries

---

## Implementation Steps

### Step 1: Implement `discover` Tool (30 min)

Unify these existing tools:
- `explain_files()` → `discover(scope="all_files")`
- `explain_folder(path)` → `discover(scope="folder", location=path)`
- `search_documents(query)` → `discover(scope="search", query=query)`

```python
@tool
def discover(
    scope: str,
    query: Optional[str] = None,
    location: Optional[str] = None
) -> Dict[str, Any]:
    """Universal discovery tool."""
    if scope == "all_files":
        return explain_files.invoke({})
    elif scope == "folder":
        return explain_folder.invoke({"folder_path": location})
    elif scope == "search":
        return search_documents.invoke({"query": query})
```

### Step 2: Implement `analyze` Tool (1 hour)

```python
@tool
def analyze(
    items: List[Dict],
    task: str,
    criteria: Optional[str] = None
) -> Dict[str, Any]:
    """
    Universal LLM-powered analysis.

    Tasks: "similarity", "categorize", "match", "compare", "extract"
    """
    # Use LLM to analyze based on task type
    # Return structured results
```

See full implementation in [TOOL_COMPOSITION_PLAN.md](TOOL_COMPOSITION_PLAN.md)

### Step 3: Implement `transform` Tool (1 hour)

```python
@tool
def transform(
    items: List[Dict],
    operation: str,
    criteria: Optional[str] = None
) -> Dict[str, Any]:
    """
    Universal LLM-powered transformation.

    Operations: "filter", "group", "sort", "select", "dedupe"
    """
    # Use LLM to transform based on operation type
    # Return transformed items
```

### Step 4: Update Prompts (30 min)

Add to `prompts/task_decomposition.md`:
```markdown
## Universal File Operation Framework

### The 4-Stage Pattern
DISCOVER → ANALYZE → TRANSFORM → ACT

### Reasoning Process
1. What things do I need? → DISCOVER
2. Do I need to understand patterns? → ANALYZE
3. Do I need to organize/filter? → TRANSFORM
4. What action should I take? → ACT

[Full framework from GENERALIZATION_ARCHITECTURE.md]
```

### Step 5: Add 3 Meta-Examples (15 min)

Add to `prompts/few_shot_examples.md`:
- Simple pattern example
- Medium pattern example
- Complex pattern example

(See Part 5 of GENERALIZATION_ARCHITECTURE.md)

### Step 6: Test & Iterate (1 hour)

Test these queries:
1. "Send all duplicated docs to my email"
2. "Find PDFs about AI and organize by date"
3. "Group images by topic and create slide deck"
4. "Archive all documents from last month"
5. "Find files similar to report.pdf"

---

## Expected Results

### Query Coverage

With just **3 universal tools + 1 pattern**, you can handle:

- ✅ Duplicate detection queries
- ✅ Content-based search queries
- ✅ Organization/categorization queries
- ✅ Similarity/comparison queries
- ✅ Filtering/selection queries
- ✅ Multi-step complex queries
- ✅ Any combination of the above

**Total:** ~95% of file/folder queries with 3 tools + pattern reasoning

### Prompt Efficiency

**Before:**
- 50+ specific examples
- 10,000+ tokens
- Overwhelming for LLM

**After:**
- 1 pattern framework
- 3 meta-examples
- ~2,000 tokens
- LLM learns to reason

---

## Key Design Principles

### 1. Minimal Tool Surface
3 universal tools instead of 20+ specialized ones

### 2. LLM Does the Reasoning
Tools execute, LLM decides how to compose them

### 3. Natural Language Criteria
No hardcoded logic - criteria specified in natural language

### 4. Pattern-Based Learning
Teach one pattern that applies universally

### 5. Embedding-Aware
Knows when to use semantic search vs. listing

---

## Success Metrics

After implementation, the system should:

- ✅ Handle "send duplicated docs" query correctly
- ✅ Work for new query types without adding examples
- ✅ Use embeddings intelligently for content-based queries
- ✅ Compose tools into multi-stage pipelines
- ✅ Provide clear reasoning at each stage

---

## Timeline

**Total Implementation Time: ~4 hours**

- Step 1 (discover): 30 min
- Step 2 (analyze): 1 hour
- Step 3 (transform): 1 hour
- Step 4 (prompts): 30 min
- Step 5 (examples): 15 min
- Step 6 (testing): 1 hour

**Result:** Universal file operation system with infinite generalization!

---

## Architecture Diagram

```
User Query: "Send all duplicated docs to my email"
                    ↓
            LLM Pattern Recognition
                    ↓
        Identifies: DISCOVER → ANALYZE → ACT
                    ↓
            ┌───────┴───────┬──────────┐
            ↓               ↓          ↓
        discover        analyze    compose_email
      (all_files)    (similarity)   (send=true)
            ↓               ↓          ↓
        All Files    Find Duplicates  Email
            ↓               ↓          ↓
            └───────────────┴──────────┘
                        ✓ SUCCESS
```

---

## Next Actions

1. **Read:** [GENERALIZATION_ARCHITECTURE.md](GENERALIZATION_ARCHITECTURE.md) for full details
2. **Implement:** The 3 universal tools (discover, analyze, transform)
3. **Update:** Prompts with pattern framework
4. **Test:** With your "duplicated docs" query
5. **Iterate:** Based on results

---

## The Big Picture

**Instead of:**
❌ 100 specific tools for 100 query types
❌ 50+ examples overwhelming the LLM
❌ Hardcoded logic for each operation

**We have:**
✅ 3 universal tools
✅ 1 reasoning pattern
✅ 3 meta-examples
✅ LLM composes primitives for ANY query

**Result:** Infinite generalization with minimal prompting!
